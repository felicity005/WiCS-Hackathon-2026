<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Path</title>
    <link rel="stylesheet" href="./stylesheets/roadmap.css">
    <link rel="stylesheet" href="sidebar-component.css">
    <script defer src="sidebar-component.js"></script>
</head>
<body>
<main class="roadmap-card">
  <h1>Your Roadmaps</h1>
  <p class="subtitle">Each selected topic has its own expandable path.</p>
  <section id="roadmapSections" class="roadmap-sections"></section>
</main>

<script>
  const ROADMAP_LENGTH = 8;
  const FALLBACK_SKILLS = {
    math: [
      "Math foundations",
      "Math problem solving",
      "Math review checkpoint"
    ],
    science: [
      "Science foundations",
      "Lab reasoning",
      "Science review checkpoint"
    ],
    compsci: [
      "Programming foundations",
      "Debugging practice",
      "Coding review checkpoint"
    ]
  };
  const SUBJECTS = [
    { key: "math", label: "Math", unit: "Step" },
    { key: "science", label: "Science", unit: "Step" },
    { key: "compsci", label: "CompSci", unit: "Step" }
  ];
  const LEGACY_FALLBACK = [
    "Learning habits",
    "Goal planning",
    "Weekly review",
    "Challenge project",
    "Mock assessment",
    "Reflection checkpoint"
  ]; 
  const SKILL_BANK = {
    Algebra: ["Linear equations", "Polynomials", "Functions and graphs"],
    Geometry: ["Angles and triangles", "Area and volume", "Coordinate geometry"],
    Precalculus: ["Trigonometry essentials", "Exponential models", "Limits intuition"],
    Calculus: ["Derivatives", "Integrals", "Optimization problems"],
    Biology: ["Cell structure", "Genetics", "Ecosystems"],
    Chemistry: ["Atomic structure", "Bonding", "Stoichiometry"],
    Physics: ["Motion and forces", "Energy", "Waves and electricity"],
    Python: ["Python syntax", "Data structures", "Mini automation scripts"],
    JavaScript: ["JS fundamentals", "DOM and events", "Async programming"],
    Java: ["OOP basics", "Collections", "Backend fundamentals"],
    "C++": ["Memory and pointers", "STL basics", "Algorithms in C++"]
  };

  function getSelectedTopicsBySubject() {
    const attempts = JSON.parse(localStorage.getItem("stemQuizAttempts")) || [];
    if (!attempts.length) {
      return { math: [], science: [], compsci: [] };
    }

    const latest = attempts[attempts.length - 1];
    return {
      math: latest.math || [],
      science: latest.science || [],
      compsci: latest.programming || []
    };
  }

  function getTopicRoadmaps() {
    const selected = getSelectedTopicsBySubject();
    return [
      ...(selected.math || []).map((topic) => ({ topic, subjectKey: "math" })),
      ...(selected.science || []).map((topic) => ({ topic, subjectKey: "science" })),
      ...(selected.compsci || []).map((topic) => ({ topic, subjectKey: "compsci" }))
    ];
  }

  function buildRoadmap(selectedTopics, subjectKey) {
    const dynamicSkills = [];
    selectedTopics.forEach((topic) => {
      (SKILL_BANK[topic] || []).forEach((skill) => {
        if (!dynamicSkills.includes(skill)) dynamicSkills.push(skill);
      });
    });

    (FALLBACK_SKILLS[subjectKey] || []).forEach((skill) => {
      if (!dynamicSkills.includes(skill)) dynamicSkills.push(skill);
    });

    LEGACY_FALLBACK.forEach((skill) => {
      if (!dynamicSkills.includes(skill)) dynamicSkills.push(skill);
    });

    return dynamicSkills.slice(0, ROADMAP_LENGTH).reverse();
  }

  function renderSubjectPath(skills, titleLabel, subjectKey, unitLabel) {
    const hasData = skills.length > 0;
    const pathRows = hasData
      ? skills
          .map(
            (skill, index) => `
          <div class="path-row ${index % 2 === 0 ? "left" : "right"}">
            <article class="path-node ${index === 0 ? "current" : ""}">
              <span class="unit">${unitLabel} ${index + 1}</span>
              <h3>${skill}</h3>
            </article>
          </div>
        `
          )
          .join("")
      : `<p class="empty-note">No steps available for ${titleLabel} yet.</p>`;

    return `
      <details class="subject-dropdown ${subjectKey}">
        <summary>
          <span>${titleLabel} Roadmap</span>
        </summary>
        <div class="path-wrap">
          <div class="path-line"></div>
          <div class="subject-path">${pathRows}</div>
        </div>
      </details>
    `;
  }

  const topicRoadmaps = getTopicRoadmaps();
  const container = document.getElementById("roadmapSections");
  if (!topicRoadmaps.length) {
    container.innerHTML = `<p class="empty-note">No quiz selections found yet. Take the quiz first, then come back to see topic roadmaps.</p>`;
  } else {
    container.innerHTML = topicRoadmaps.map(({ topic, subjectKey }) => {
      const skills = buildRoadmap([topic], subjectKey);
      return renderSubjectPath(skills, topic, subjectKey, "Step");
    }).join("");
  }

</script>

</body>
</html>

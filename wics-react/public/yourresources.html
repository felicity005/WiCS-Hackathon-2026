<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Resources</title>
  <link rel="stylesheet" href="stylesheets/yourresources.css">
  <link rel="stylesheet" href="sidebar-component.css">
  <script defer src="sidebar-component.js"></script>
</head>
<body>
  <main class="resources-shell">
    <header class="page-head">
      <h1>Your Resources</h1>
      <p>Automatic YouTube search based on your latest quiz selections.</p>
      <div id="topicChips" class="topic-chips"></div>
    </header>

    <section id="status" class="status-card">Searching YouTube for your selected topics...</section>
    <section id="results" class="results-grid"></section>
  </main>

  <script>
    const API_KEY = "AIzaSyDDNb40PwR1mM-dU7JqGMjX5AQerXFeWz4";
    const YT_LIMIT = 6;
    const SUBJECT_TOPICS = {
      math: new Set(["Algebra", "Geometry", "Precalculus", "Calculus"]),
      science: new Set(["Biology", "Chemistry", "Physics"]),
      compsci: new Set(["Python", "JavaScript", "Java", "C++"])
    };

    function getSubject(topic) {
      if (SUBJECT_TOPICS.math.has(topic)) return "math";
      if (SUBJECT_TOPICS.science.has(topic)) return "science";
      if (SUBJECT_TOPICS.compsci.has(topic)) return "compsci";
      return "math";
    }

    function latestTopics() {
      const attempts = JSON.parse(localStorage.getItem("stemQuizAttempts")) || [];
      if (!attempts.length) return [];
      const latest = attempts[attempts.length - 1];
      const combined = [
        ...(latest.math || []),
        ...(latest.science || []),
        ...(latest.programming || [])
      ];
      return [...new Set(combined)];
    }

    async function getYouTube(topic) {
      const q = `${topic} tutorial beginner`;
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=${YT_LIMIT}&order=relevance&q=${encodeURIComponent(q)}&key=${API_KEY}`;
      const response = await fetch(url);
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error?.message || "YouTube search failed");
      }

      const items = (data.items || []).filter((item) => item.id && item.id.videoId);
      if (!items.length) return [];

      const ids = items.map((item) => item.id.videoId).join(",");
      const statsUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${ids}&key=${API_KEY}`;
      const statsResponse = await fetch(statsUrl);
      const statsData = await statsResponse.json();

      const likeMap = {};
      if (statsResponse.ok) {
        (statsData.items || []).forEach((video) => {
          likeMap[video.id] = video.statistics?.likeCount || "0";
        });
      }

      return items.map((item) => ({
        title: item.snippet?.title || "Untitled",
        url: `https://www.youtube.com/watch?v=${item.id.videoId}`,
        thumbnail: item.snippet?.thumbnails?.medium?.url || item.snippet?.thumbnails?.default?.url || "",
        channel: item.snippet?.channelTitle || "Unknown channel",
        likes: likeMap[item.id.videoId] || "0"
      }));
    }

    function renderTopicChips(topics) {
      const chips = document.getElementById("topicChips");
      chips.innerHTML = topics
        .map((topic) => `<span class="chip chip--${getSubject(topic)}">${topic}</span>`)
        .join("");
    }

    function renderTopicResults(topic, videos, errorMessage) {
      const section = document.createElement("article");
      section.className = `topic-card topic-card--${getSubject(topic)}`;

      const videoGrid = videos.length
        ? videos.map((v) => `
            <a class="video-tile video-tile--${getSubject(topic)}" href="${v.url}" target="_blank" rel="noreferrer">
              <img src="${v.thumbnail}" alt="${v.title}">
              <div class="video-copy">
                <h3>${v.title}</h3>
                <p>${v.channel}</p>
                <span>${Number(v.likes).toLocaleString()} likes</span>
              </div>
            </a>
          `).join("")
        : `<p>${errorMessage || "No YouTube results found for this topic."}</p>`;

      section.innerHTML = `
        <h2>${topic}</h2>
        <div class="videos-grid">${videoGrid}</div>
      `;

      return section;
    }

    async function runSearches() {
      const status = document.getElementById("status");
      const results = document.getElementById("results");
      const topics = latestTopics();

      if (!topics.length) {
        status.textContent = "No quiz selections found yet. Take the quiz first, then return here.";
        return;
      }

      renderTopicChips(topics);
      status.textContent = `Searching ${topics.length} selected topic${topics.length > 1 ? "s" : ""} on YouTube...`;

      const tasks = topics.map(async (topic) => {
        let videos = [];
        let errorMessage = "";

        try {
          videos = await getYouTube(topic);
        } catch (err) {
          videos = [];
          errorMessage = err.message;
        }

        return renderTopicResults(topic, videos, errorMessage);
      });

      const sections = await Promise.all(tasks);
      sections.forEach((node) => results.appendChild(node));
      const hasAnyVideo = Array.from(results.querySelectorAll(".video-tile")).length > 0;
      status.textContent = hasAnyVideo
        ? "Search complete."
        : "No YouTube results loaded. Check API key, quota, and allowed referrers.";
    }

    runSearches();
  </script>
</body>
</html>
